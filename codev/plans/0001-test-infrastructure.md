# План: инфраструктура тестирования установки Codev

## Метаданные
- **ID**: 0001-test-infrastructure
- **Спецификация**: [codev/specs/0001-test-infrastructure.md](/codev/specs/0001-test-infrastructure.md)
- **Статус**: завершён
- **Автор**: Claude (совместно с Waleed)
- **Создан**: 2025-01-20
- **Завершён**: 2025-01-20

## Обзор
Этот план реализует набор тестов на shell для проверки процесса установки Codev. На основе утверждённой спецификации мы используем фреймворк bats-core, чтобы создать структурированные тесты, проверяющие результаты установки без необходимости сетевого доступа или сложных зависимостей.

## Метрики успеха
- [x] Все три ключевых сценария тестирования проходят
- [x] Быстрые тесты (без участия Claude) выполняются менее чем за 30 секунд через `run-tests.sh`
- [x] Интеграционные тесты (с участием Claude) запускаются отдельно через `run-all-tests.sh`
- [x] Для основных тестов не требуется доступ к сети
- [x] Тесты работают на macOS и Linux
- [x] Понятная отчётность pass/fail с TAP-выводом bats

## Разбивка по фазам

### Фаза 1: Настройка тестового фреймворка и структуры [ВЫПОЛНЕНО]
**Цель**: Создать фундамент тестовой инфраструктуры на базе bats-core

**Зависимости**: нет

**Задачи**:
1. Создать структуру директории `tests/`
2. Зависимости вендорятся вручную:
   - bats-support (хелперы)
   - bats-assert (утверждения)
   - bats-file (проверки файлов)
3. Создать скрипт запуска `run-tests.sh` (только быстрые тесты)
4. Создать скрипт `run-integration-tests.sh` (тесты Claude)
5. Настроить базовые тестовые хелперы с teardown для гарантированной очистки
6. Проверить, что bats успешно запускается

**Артефакты**:
- Рабочая установка bats-core в tests/lib/
- Создана базовая структура тестов
- Скрипт run-tests.sh работоспособен

**Критерии успеха**:
- Команда `./scripts/run-tests.sh` завершается без ошибок
- Фреймворк bats загружается и сообщает версию
- Структура директорий соответствует спецификации

---

### Фаза 2: [ВЫПОЛНЕНО] Реализация базовых тестовых хелперов
**Цель**: Создать многоразовые утилиты для моков и подготовки окружения

**Зависимости**: Фаза 1 (фреймворк настроен)

**Задачи**:
1. Создать helper mock_mcp для имитации наличия Zen
2. Создать helper setup_test_project на основе mktemp
3. Реализовать функцию teardown для гарантированной очистки (даже при падении теста)
4. Создать helper install_from_local для копирования codev-skeleton
5. Сделать assert-хелперы для структуры директорий
6. Исправить ошибки в INSTALL.md (флаг tar, команда cp)

**Артефакты**:
- `tests/helpers/common.bash` с подготовкой проекта
- `tests/helpers/mock_mcp.bash` для симуляции Zen
- Обновлённый INSTALL.md с правками

**Критерии успеха**:
- Хелперы создают изолированную тестовую директорию
- mock mcp корректно имитирует наличие/отсутствие сервера
- Копирование skeleton работает с dot-файлами

---

### Фаза 3: [ВЫПОЛНЕНО] Тест SPIDER (Zen присутствует)
**Цель**: Проверить чистую установку при доступном Zen MCP

**Зависимости**: Фаза 2 (хелперы готовы)

**Задачи**:
1. Создать тест `01_fresh_spider.bats`
2. Смоделировать наличие Zen MCP
3. Скопировать локальный skeleton в тестовый каталог
4. Создать CLAUDE.md с протоколом SPIDER
5. Проверить структуру директорий и содержимое файлов

**Артефакты**:
- Рабочий тест установки SPIDER
- Проверка выбора протокола
- Валидация всех необходимых директорий

**Критерии успеха**:
- Тест стабильно проходит
- В CLAUDE.md обнаруживается протокол SPIDER
- Все требуемые директории существуют

---

### Фаза 4: [ВЫПОЛНЕНО] Тест SPIDER-SOLO (Zen отсутствует)
**Цель**: Проверить чистую установку при отсутствии Zen MCP

**Зависимости**: Фаза 2 (хелперы готовы)

**Задачи**:
1. Создать тест `02_fresh_spider_solo.bats`
2. Убедиться, что в PATH нет mcp
3. Скопировать skeleton в тестовый каталог
4. Создать CLAUDE.md с протоколом SPIDER-SOLO
5. Проверить корректность выбора протокола

**Артефакты**:
- Рабочий тест fallback на SPIDER-SOLO
- Проверка поведения при отсутствии Zen
- Валидация структуры директорий

**Критерии успеха**:
- Тест стабильно проходит
- Правильно выбирается SPIDER-SOLO при отсутствии Zen
- Все требуемые директории существуют

---

### Фаза 5: [ВЫПОЛНЕНО] Тест обновления существующего CLAUDE.md
**Цель**: Проверить обновление уже имеющегося файла CLAUDE.md

**Зависимости**: Фаза 2 (хелперы готовы)

**Задачи**:
1. Создать тест `03_existing_claude.bats`
2. Предсоздать CLAUDE.md с существующим содержимым
3. Запустить процесс установки
4. Убедиться, что блок Codev добавлен
5. Проверить, что исходный контент сохранён

**Артефакты**:
- Рабочий тест для обновления существующего файла
- Проверка бережных правок
- Гарантия сохранения контента

**Критерии успеха**:
- Исходное содержимое CLAUDE.md сохранено
- Блок Codev корректно добавлен
- Дубликаты разделов не появляются

---

### Фаза 6: [ВЫПОЛНЕНО] Тесты выполнения Claude
**Цель**: Проверить реальные вызовы Claude с изоляцией

**Зависимости**: Фазы 3-5 завершены

**Задачи**:
1. Создать `04_claude_execution.bats` для реальных тестов с Claude
2. Использовать строгие флаги изоляции Claude:
   - `--strict-mcp-config --mcp-config '[]'` (без MCP-серверов)
   - `--settings '{}'` (без пользовательских настроек)
3. Проверить выполнение Claude инструкций по установке
4. Сравнить конечное состояние файловой системы с «золотым» эталоном из тестов фаз 3/4
5. Тесты должны пропускаться, если Claude недоступен (для контрибьюторов без API)
6. Запускать через отдельный скрипт `run-integration-tests.sh` (медленные тесты)

**Артефакты**:
- Интеграционные тесты с реальным Claude
- Проверка фактического выполнения инструкций AI
- Только локальный запуск (не для CI/CD из-за API-ключей)

**Критерии успеха**:
- Claude проводит установку в полностью изолированной среде
- Итоговое состояние файлов совпадает с эталоном из shell-тестов
- Тесты работают локально у разработчиков с установленным Claude
- В средах без Claude тесты корректно пропускаются
- Интеграционные тесты отделены от быстрого цикла обратной связи

---

### Фаза 7: [ВЫПОЛНЕНО] Документация
**Цель**: Описать использование тестов для локальной разработки

**Зависимости**: Все тесты реализованы

**Задачи**:
1. Создать `tests/README.md` с инструкциями
2. Описать запуск тестов локально с Claude
3. Описать поведение тестов без Claude (graceful skip)
4. Объяснить, как добавлять новые тесты
5. Подготовить раздел с устранением неполадок

**Артефакты**:
- Полная документация по тестам
- Гайд по локальному запуску
- Инструкции по расширению набора тестов

**Критерии успеха**:
- Понятные инструкции по запуску локально
- Описанные шаги отладки сбоев
- Руководство по добавлению новых кейсов
- Примечание: CI/CD отложен из-за требований к API-ключам Claude
