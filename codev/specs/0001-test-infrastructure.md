# Спецификация: инфраструктура тестирования установки Codev

## Метаданные
- **ID**: 0001-test-infrastructure
- **Статус**: черновик
- **Создано**: 2025-01-20
- **Мультиагентность**: да (GPT-5 и Gemini Pro)

## Постановка задачи
На данный момент нет автоматизированного способа убедиться, что процесс установки Codev работает корректно. Установка включает несколько шагов: загрузку файлов, создание директорий и потенциальное взаимодействие с AI-агентами. Нам нужна инфраструктура тестов, которая проверяет установку в разных сценариях и подтверждает ожидаемый результат.

## Текущее состояние
- Инструкции по установке описаны в INSTALL.md
- Процесс выполняется вручную и не покрыт тестами
- Нет способа проверить успешное завершение установки
- Нет регрессионных тестов при изменении процесса установки
- Установка сочетает shell-команды и взаимодействие с AI-агентом

## Желаемое состояние
- Автоматизированный набор тестов, валидирующий процесс установки
- Сценарии для разных вариантов установки (с/без Zen MCP, новый и существующий CLAUDE.md)
- Проверка, что все файлы создаются в нужных местах
- Подтверждение, что итоговая структура соответствует ожиданиям
- Понятные отчёты о результатах (что прошло, что нет)
- Возможность запускать тесты локально и в CI/CD

## Заинтересованные стороны
- **Основные пользователи**: сопровождающие Codev, которым нужно гарантировать исправность установки
- **Вторичные пользователи**: контрибьюторы, желающие убедиться, что их изменения не ломают установку
- **Конечные пользователи**: разработчики, устанавливающие Codev и рассчитывающие на стабильность процесса

## Критерии успеха
- [ ] Набор тестов способен смоделировать «чистую» установку
- [ ] Тесты проверяют, что файлы создаются в правильных местах
- [ ] Тесты сверяют содержимое файлов с ожидаемыми шаблонами
- [ ] Тесты покрывают пути установки SPIDER и SPIDER-SOLO
- [ ] Тесты умеют имитировать наличие/отсутствие сервера Zen MCP
- [ ] Тесты проверяют обновление CLAUDE.md (новый файл и уже существующий)
- [ ] Запуск полного набора одной командой
- [ ] Все тесты проходят, покрывая >90% сценариев установки
- [ ] Есть понятная документация о запуске и расширении тестов

## Ограничения
### Технические
- Должны работать без фактической установки сервера Zen MCP
- Для базовых тестов не нужен сетевой доступ (мокаем загрузку с GitHub)
- Необходимо протестировать взаимодействия с AI (текстовые инструкции)
- Поддержка распространённых платформ разработки (macOS, Linux)
- Нельзя напрямую тестировать выполнение инструкций Claude (проверяем результаты)

### Бизнес-ограничения
- Должно быть достаточно простым для понимания и модификации контрибьюторами
- Нельзя добавлять тяжёлые зависимости
- Полный цикл тестов должен укладываться в 30 секунд

## Допущения
- Python доступен в инфраструктуре тестов (обычно для разработки)
- Мы можем замокать процесс загрузки через curl/tar
- Возможно проверять состояние файловой системы, даже если напрямую не тестируем AI
- Контрибьюторы запускают тесты до отправки PR

## Варианты решений

### Подход 1: Набор тестов на shell-скриптах (ВЫБРАН)
**Описание**: создать bash-набор тестов, запускающий команды установки и проверяющий результат

**Плюсы**:
- Нет дополнительных языковых зависимостей
- Тестируем реальные shell-команды из INSTALL.md
- Понятно разработчикам, знакомым с shell
- Легко проверять операции с файловой системой
- Сохраняет простоту без отдельного install.sh

**Минусы**:
- Ограниченные возможности тестового фреймворка
- Труднее мокать внешние зависимости
- Менее структурированная отчётность
- Сложнее аккуратно тестировать крайние случаи

**Решение пользователя**: выбран за простоту и чтобы избежать создания install.sh

**Оценка сложности**: средняя
**Уровень риска**: низкий

### Подход 2: Python + канонический install.sh
**Описание**: создать канонический `install.sh` как единственный источник истины и тестировать его с помощью pytest

**Плюсы**:
- Один авторитетный скрипт установки
- Тестируем реальный shell-скрипт (находим проблемы с кавычками, PATH)
- Богатая экосистема тестирования (pytest, моки, фикстуры)
- Проще мокать внешние зависимости (команда mcp, сеть)
- Структурированная отчётность и метрики покрытия
- Удобно симулировать разные сценарии установки
- Легко интегрировать в CI/CD
- Оффлайн-режим для быстрых надёжных тестов

**Минусы**:
- Добавляет Python как зависимость тестов (приемлемо)
- Нужно поддерживать синхронизацию install.sh и INSTALL.md

**Оценка сложности**: средняя
**Уровень риска**: низкий

### Подход 3: Интеграционные тесты на Docker
**Описание**: использовать контейнеры Docker для проверки установки в изолированной среде

**Плюсы**:
- Реальная установка в «чистой» среде
- Можно тестировать под разными ОС
- Полная изоляция от машины разработчика
- Максимально приближено к реальности

**Минусы**:
- Требуется Docker
- Медленное выполнение
- Более сложная настройка
- Сложнее отлаживать сбои
- Избыточно для базовой проверки

**Оценка сложности**: высокая
**Уровень риска**: средний (отложить до v2)

## Открытые вопросы

### Критичные (блокировали прогресс)
- [x] Как тестировать часть инструкций для AI-агента?
  - **Ответ**: создавать безопасные временные директории и проверять состояние файлов
  - **Обновление**: можно запускать Claude в изоляции с флагами `--strict-mcp-config` и `--settings`
- [x] Нужно ли проверять реальную загрузку из GitHub или всегда мокать?
  - **Ответ**: использовать локальную директорию codev-skeleton

### Важные (влияют на дизайн)
- [x] Нужна ли поддержка Windows или достаточно Unix-подобных систем?
  - **Ответ**: только Unix-системы
- [x] Должны ли тесты работать без сети?
  - **Ответ**: не обязательно, но всё равно используем локальный skeleton
- [x] Как тестировать обнаружение Zen MCP?
  - **Ответ**: мокать

### Приятно иметь (оптимизация)
- [ ] Можно ли автоматически генерировать тест-кейсы из INSTALL.md?
  - **Отложено**: не требуется для v1
- [ ] Стоит ли проверять сценарии обновления (существующий Codev → новая версия)?
  - **Отложено**: не для v1

## Требования к производительности
- **Время выполнения тестов**: < 30 секунд для полного набора
- **Время одного теста**: < 2 секунд
- **Ресурсы**: минимальное использование CPU/памяти (желательно)
- **Параллелизм**: возможность параллельного выполнения (желательно)

## Соображения безопасности
- Тесты не должны требовать привилегий суперпользователя
- Нельзя изменять системные файлы вне тестовых директорий
- Все тестовые артефакты корректно очищаются
- В логах не должно быть чувствительной информации

## Сценарии тестирования
### Функциональные тесты
1. Чистая установка без существующих файлов
2. Установка при наличии CLAUDE.md
3. Установка при доступном сервере Zen MCP
4. Установка без Zen MCP (fallback на SPIDER-SOLO)
5. Проверка создания всех директорий (specs/, plans/, reviews/, resources/, protocols/)
6. Проверка корректного копирования файлов протокола
7. Проверка создания llms.txt в resources/
8. Проверка очистки временной директории установки
9. **Тест выполнения Claude** (опционально):
   - Запуск `claude --strict-mcp-config --mcp-config '[]'` в тестовой директории
  - Передача инструкций INSTALL.md на вход
  - Проверка, что Claude завершает установку без влияния пользовательских настроек

### Крайние случаи (отложены до v2)
Тестирование edge-case сценариев отложено по запросу пользователя — сосредоточимся на позитивных сценариях в v1.

## Зависимости
- **Внешние сервисы**: GitHub — будем использовать локальную директорию codev-skeleton
- **Внутренние системы**: операции с файловой системой, shell-команды
- **Библиотеки/фреймворки**: shell-тестирование (возможен bats)

## Ссылки
- [INSTALL.md](/INSTALL.md)
- [Структура codev-skeleton](/codev-skeleton/)
- Лучшие практики тестирования ПО

## Риски и стратегии смягчения
| Риск | Вероятность | Влияние | Стратегия |
|------|-------------|---------|-----------|
| Нельзя напрямую протестировать AI | Высокая | Среднее | Проверять состояние файловой системы |
| Тесты устаревают | Средняя | Высокое | Пускать в CI/CD, держать простыми |
| Платформенные нюансы | Средняя | Среднее | Сфокусироваться на Unix-системах |
| Мокинг усложняет код | Низкая | Среднее | Начать с простых файловых моков |

## Определение объёма V1 (с учётом обратной связи)

### В объёме V1
1. **Набор shell-тестов**, который:
   - Запускает команды установки напрямую из INSTALL.md
