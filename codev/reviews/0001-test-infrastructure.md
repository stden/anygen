# Извлечённые уроки: реализация инфраструктуры тестирования

## Метаданные
- **ID**: 0001-test-infrastructure
- **Спецификация**: [codev/specs/0001-test-infrastructure.md](/codev/specs/0001-test-infrastructure.md)
- **План**: [codev/plans/0001-test-infrastructure.md](/codev/plans/0001-test-infrastructure.md)
- **Завершено**: 2025-01-20

## Что прошло хорошо

### 1. Выбор тестирования на shell
Решение использовать bats-core вместо Python оказалось отличным:
- **Нулевые зависимости** кроме bash и git
- **Высокая скорость** — тесты выполняются за секунды
- **Кроссплатформенность** — без изменений работает на macOS и Linux
- **Простая отладка** — shell-скрипты прозрачны и легко трассируются

### 2. Ценность консультации нескольких агентов
Эксперты помогли обнаружить критичные проблемы:
- **GPT-5 выявил** риски с PATH в фазе 2
- **Gemini Pro подсказал** необходимость тестов структуры директорий
- **Оба эксперта отметили** важность XDG-песочницы в фазе 6
- **Нарушения протокола предотвращены** благодаря явным контрольным точкам

### 3. Стратегия организации тестов
Группировка по сценариям, а не по техническим деталям, сработала:
- Чёткое разделение фреймворка, протоколов и интеграции
- Удобно запускать подмножества (быстрые против интеграционных)
- Логическое наращивание сложности от базовых к сложным сценариям

### 4. Стратегия моков
Создание «ломающих» шимов вместо удаления команд из PATH было удачным ходом:
- Более реалистично (команда существует, но завершается с ошибкой)
- Не нужно заново собирать PATH
- Исключён риск случайно найти системную команду

## Что оказалось сложным

### 1. Соблюдение протокола
Мы нарушили SPIDER дважды, пропуская консультацию:
- **Фаза 1**: показали результат без консультации
- **Фаза 3**: получили промежуточный отзыв, но не финальное одобрение после правок

**Принятое решение**: обновили CLAUDE.md, добавив явные контрольные точки, и уточнили протокол по срокам консультаций.

### 2. Содержимое протокола SPIDER-SOLO
В фазе 4 обнаружилось, что `protocol.md` для SPIDER-SOLO — просто копия SPIDER с упоминанием мультиконсультации.

**Причина**: копирование шаблона без дифференциации
**Решение**: полностью переписали SPIDER-SOLO для варианта с самооценкой

### 3. Платформенные различия
Возникли проблемы совместимости:
- Различия синтаксиса `find` в BSD и GNU
- Отличающиеся флаги у команды `stat`
- Наличие `timeout` против `gtimeout`

**Решение**: использовать переносимые альтернативы и детектировать платформу с условной логикой

### 4. Изоляция тестовой среды
Первые тесты изменяли реальные директории $HOME/.config:
- **Риск**: повреждение пользовательских настроек
- **Кто обнаружил**: консультация экспертов в фазе 6

**Решение**: XDG-песочница — установка XDG_CONFIG_HOME в тестовый каталог

## Что сделали бы иначе

### 1. Раннее внедрение XDG-песочницы
Следовало внедрить изоляцию окружения уже в фазе 1, а не в фазе 6, чтобы исключить риски для пользовательских директорий с самого начала.

### 2. Явное отслеживание консультаций
Создавать чек-лист или использовать TodoWrite для контроля консультаций:
```
- [ ] Первая реализация
- [ ] Первичная консультация экспертов
- [ ] Внесение исправлений
- [ ] Финальное одобрение экспертов
- [ ] Презентация пользователю
```

### 3. Проверки протоколов до использования
Нужно было сначала написать тест, который верифицирует содержимое SPIDER-SOLO, — это сразу выявило бы проблему дублирования.

### 4. Детекция timeout-утилит
Следовало один раз определить доступность `timeout` в setup, а не повторять проверку в каждом тесте. Позже исправили, но лучше было сделать сразу.

## Требуются улучшения методологии

### 1. Улучшения протокола SPIDER

**Добавить в protocol.md**:
- Явное требование «ФИНАЛЬНОЕ одобрение от всех экспертов после внесения правок»
- Уточнение, что консультация должна проходить ДО предъявления результатов пользователю
- Требование проверять, что предыдущая фаза закоммичена перед стартом следующей

**Статус**: изменения внесены в ходе проекта.

### 2. Стандарты инфраструктуры тестов

**Предложения для методологии Codev**:
- Всегда использовать XDG-песочницу, если тесты затрагивают пользовательские конфиги
- Тестировать поведение, а не реализацию (избегать чрезмерного мокинга)
- Отдавать предпочтение переносимым shell-конструкциям, избегать GNU-специфики
- Создавать контрольные тесты дефолтного поведения перед тестами переопределений

### 3. Требования к документации

**Для будущих тестовых проектов**:
- Заранее документировать требования к timeout
- Перечислять все внешние командные зависимости
- Указывать минимальную версию bash (4.0+)
- Включать матрицу совместимости по платформам

### 4. Вопросы CI/CD

**Пока не реализовано, но необходимо**:
- Workflow GitHub Actions для запуска тестов
- Матрица macOS/Linux
- Отдельная задача для интеграционных тестов (при наличии Claude)
- Отчётность по результатам и бейджи

## Влияние на будущую разработку

### Положительные практики для повторения
1. **Вендоринг зависимостей тестов** — включать bats-core прямо в репозиторий
2. **Герметичное тестирование** — не затрагивать реальное окружение
3. **Плавная деградация** — пропускать тесты при отсутствии зависимостей
4. **Консультация экспертов** — заранее выявлять проблемы через мультиагентный обзор

### Антипаттерны, которых стоит избегать
1. **Изменение $HOME** — всегда песочница
2. **Слабые утверждения** — никаких `|| true` или «assert true»
3. **Платформенные предположения** — тестировать и на macOS, и на Linux
4. **Пропуск консультаций** — всегда проходить полный цикл ревью

## Рекомендации по обновлению протокола

### 1. Детекция чрезмерного мокинга
В фазе Defend протокола стоит явно упоминать проверку на overmocking.

### 2. Уточнение требований к коммитам
Каждая фаза должна завершаться коммитом — нужно сделать это требование более заметным.

### 3. Сроки консультации экспертов
Протокол теперь корректно указывает, что консультация проходит до обращения к пользователю, а не после.

## Системные проблемы

В фазе Review мы отметили повторяющиеся паттерны:

1. **Соблюдение протокола** — пропуск консультаций дважды привёл к доработкам
2. **Дублирование шаблонов** — SPIDER-SOLO некорректно копировал SPIDER
3. **Совместимость платформ** — постоянные вопросы BSD/GNU и доступности инструментов
4. **Безопасность окружения** — поздний переход на песочницу (нужно с фазы 1)
5. **Пробелы в документации** — фаза Review не акцентировала необходимость обновить все материалы

Проблемы решены через обновления протокола и документации.

## Итог

Инфраструктура тестов реализована успешно: создано 52 теста, обеспечивающих надёжность установки Codev. Протокол SPIDER подтвердил свою полезность: консультация нескольких агентов помогла вскрыть критические проблемы.

Ключевые факторы успеха:
- **Верный технологический выбор** (shell/bats вместо Python)
- **Консультация экспертов** (рано выявлены вопросы безопасности и дизайна)
- **Инкрементальная поставка** (каждая фаза приносила ценность)
- **Быстрые циклы обратной связи** (тесты работают за секунды)

Главный урок: **следовать протоколу** — оба раза, когда мы пропускали консультацию, приходилось переделывать.

## Следующие шаги

После завершения инфраструктуры тестов рекомендуем приоритеты:
1. **Интеграция с CI/CD** — добавить GitHub Actions
2. **Отчётность по покрытию** — отслеживать метрики тестов
3. **Проверка производительности** — добавить проверки времени выполнения
4. **Набор интеграционных тестов** — расширить сценарии выполнения Claude
5. **Поддержка Windows** — добавить совместимость с WSL/GitBash
