# Инструкции проекта Codev для AI-агентов

> **Проект**: Codev - Context-Driven Development Framework
> **Репозиторий**: Настраивается через переменные окружения
> **Статус**: В разработке
> **Язык**: Русский (вся документация, код, комментарии)

## Контекст проекта

**Codev** — фреймворк для многофазной разработки с участием AI-агентов. Он стандартизирует подготовку спецификаций, планирование, реализацию и анализ уроков по завершённым задачам.

### Ключевые особенности Codev:
- ✅ Полный перевод документации на русский
- ✅ 6 специализированных AI-агентов (TDD, BDD, ENV, архитектура, обновление)
- ✅ Лучшие практики из анализа множества production проектов
- ✅ Безопасность: все личные данные в `.env`, а не в Git
- ✅ GitHub Actions CI/CD с Python BDD тестами (behave framework)
- ✅ Zen MCP интеграция для мультиагентной консультации (Gemini 2.5 Pro, GPT-5, Grok)

### Источники истины:
- Протоколы Codev обеспечивают предсказуемый цикл разработки и прозрачную трассировку решений
- Артефакты (`specs`, `plans`, `reviews`) являются источником правды: всегда синхронизируйте их с текущим состоянием проекта
- Этот файл служит рабочей шпаргалкой: сверяйтесь с ним перед стартом задачи и после каждого ключевого шага
- `RECIPES.md` содержит удачные рецепты и лучшие практики из production проектов

## Навигация

- [Быстрый старт](#быстрый-старт)
- [Руководство по выбору протокола](#руководство-по-выбору-протокола)
- [Основной рабочий процесс](#основной-рабочий-процесс)
- [Специализированные агенты](#специализированные-агенты)
- [Рабочий процесс Git](#рабочий-процесс-git)
- [Лучшие практики](#-лучшие-практики-для-ai-генерируемого-кода)
- [Чеклист проекта](#-универсальный-чеклист-для-нового-проекта)

## Быстрый старт

1. Сформулируйте тип запроса пользователя и оцените размер задачи (объём кода, сложность архитектуры).
2. Ознакомьтесь с существующими артефактами: спецификациями (`codev/specs/`), планами (`codev/plans/`), уроками (`codev/reviews/`).
3. Выберите подходящий протокол, руководствуясь разделом ниже, и откройте его `protocol.md`.
4. Создайте или обновите нужные документы по шаблонам из `codev/protocols/<protocol>/templates/`.
5. Зафиксируйте необходимые консультации: по умолчанию подключайте Gemini 2.5 Pro и GPT-5 на контрольных этапах.

**Доступные протоколы**:
- **SPIDER**: Многофазная разработка с консультацией - `codev/protocols/spider/protocol.md`
- **SPIDER-SOLO**: Вариант с одним агентом - `codev/protocols/spider-solo/protocol.md`
- **TICK**: Быстрая автономная реализация - `codev/protocols/tick/protocol.md`

Ключевые расположения:
- Детали протоколов: `codev/protocols/` (Выберите подходящий протокол)
- Спецификации размещаются в: `codev/specs/`
- Планы размещаются в: `codev/plans/`
- Обзоры размещаются в: `codev/reviews/`

## Руководство по выбору протокола

### Используйте TICK для:
- Небольших функций (< 300 строк кода)
- Хорошо определённых задач с чёткими требованиями
- Исправления ошибок с известными решениями
- Простых изменений конфигурации
- Добавления утилитных функций
- Задач, требующих быстрой итерации

### Используйте SPIDER для:
- Новых протоколов или вариантов протоколов
- Серьёзных изменений существующих протоколов
- Новых примеров проектов
- Значительных изменений процесса установки
- Сложных функций, требующих нескольких фаз
- Изменений архитектуры
- Решений по проектированию системы

### Пропускайте формальные протоколы для:
- Опечаток в README или незначительных исправлений документации
- Небольших исправлений ошибок в шаблонах
- Обновлений зависимостей

## Основной рабочий процесс

1. **Когда просят создать НОВЫЕ ФУНКЦИИ ДЛЯ CODEV**: Начните с фазы Спецификации
2. **Создавайте ровно ТРИ документа на функцию**: спецификация, план и уроки (все с одинаковым именем файла)
3. **Следуйте фазам SP(IDE)R**: Specify → Plan → (Implement → Defend → Evaluate) → Review
4. **Используйте мультиагентную консультацию по умолчанию** если только пользователь не скажет "без консультации"

### КРИТИЧЕСКИЕ КОНТРОЛЬНЫЕ ТОЧКИ КОНСУЛЬТАЦИИ (НЕ ПРОПУСКАЙТЕ):
- После написания кода реализации → СТОП → Консультируйтесь с GPT-5 и Gemini Pro
- После написания тестов → СТОП → Консультируйтесь с GPT-5 и Gemini Pro
- ТОЛЬКО ЗАТЕМ представляйте результаты пользователю для оценки

## Структура каталогов
```
project-root/
├── codev/
│   ├── protocols/           # Протоколы разработки
│   │   ├── spider/         # Многофазная разработка с консультацией
│   │   ├── spider-solo/    # Вариант SPIDER с одним агентом
│   │   └── tick/           # Быстрая автономная реализация
│   ├── specs/              # Спецификации функций (ЧТО строить)
│   ├── plans/              # Планы реализации (КАК строить)
│   ├── reviews/            # Обзоры и извлечённые уроки из каждой функции
│   └── resources/          # Справочные материалы
│       └── arch.md         # Документация архитектуры (поддерживается агентом)
├── .claude/
│   └── agents/             # Определения AI-агентов
│       ├── spider-protocol-updater.md
│       ├── architecture-documenter.md
│       └── codev-updater.md
├── CLAUDE.md              # Этот файл
└── [код проекта]
```

## Соглашение об именовании файлов

Используйте последовательную нумерацию с описательными именами:
- Спецификация: `codev/specs/0001-имя-функции.md`
- План: `codev/plans/0001-имя-функции.md`
- Обзор: `codev/reviews/0001-имя-функции.md`

**Примечание**: Последовательная нумерация общая для всех протоколов (SPIDER, SPIDER-SOLO, TICK)

## Мультиагентная консультация

**ПОВЕДЕНИЕ ПО УМОЛЧАНИЮ**: Консультация ВКЛЮЧЕНА по умолчанию с:
- **Gemini 2.5 Pro** (gemini-2.5-pro) для глубокого анализа
- **GPT-5** (gpt-5) для дополнительной перспективы

Для отключения: Пользователь должен явно сказать "без мультиагентной консультации"

**Контрольные точки консультации**:
1. **Фаза спецификации**: После черновика и после человеческого обзора
2. **Фаза планирования**: После создания плана и после человеческого обзора
3. **Фаза реализации**: После реализации кода
4. **Фаза защиты**: После создания тестов
5. **Фаза оценки**: После завершения оценки
6. **Фаза обзора**: После документа обзора

## Специализированные агенты

Агенты в `.claude/agents/` автоматизируют повторяющиеся задачи Codev. Обращайтесь к ним, когда нужно сохранить стандарты и ускорить работу.

### Spider Protocol Updater
- **Цель**: анализирует внешние реализации SPIDER и предлагает улучшения основного протокола.
- **Вызывайте когда**: проводите периодический аудит, получили сигнал об улучшениях извне или проверяете конкретный репозиторий на полезные практики.
- **Основные действия**: сравнивает `protocol.md`, просматривает уроки и обзоры, классифицирует находки (универсальные/доменные/эксперимент/антипаттерн) и формирует рекомендации.
- **Пример запроса**:
  ```bash
  "Проверь репозиторий ansari-project/webapp на улучшения SPIDER"
  ```
- **Файл агента**: `.claude/agents/spider-protocol-updater.md`

### Architecture Documenter
- **Цель**: поддерживает `codev/resources/arch.md` в актуальном состоянии.
- **Вызывайте когда**: завершили крупную реализацию, добавили новые модули, проводите фазу обзора или нужно синхронизировать архитектуру со спецификациями.
- **Основные действия**: собирает архитектурные сведения из спецификаций/планов/обзоров, сверяет их с кодом и обновляет документацию (структура каталогов, утилиты, паттерны, интеграции).
- **Пример запроса**:
  ```bash
  "Обнови arch.md после интеграции нового сервиса аутентификации"
  ```
- **Файл агента**: `.claude/agents/architecture-documenter.md`

### Codev Updater
- **Цель**: обновляет локальную установку Codev до последней версии без потери артефактов.
- **Вызывайте когда**: выходят новые протоколы, требуется синхронизировать шаблоны или нужна проверка доступных обновлений (рекомендуется минимум раз в месяц).
- **Основные действия**: проверяет текущую установку, получает обновления, делает резервные копии, обновляет протоколы и агентов, подтверждает успешность и предоставляет инструкции по откату.
- **Пример запроса**:
  ```bash
  "Пожалуйста, обнови мой фреймворк codev до последней версии"
  ```
- **Файл агента**: `.claude/agents/codev-updater.md`

## Рабочий процесс Git

### 🚨 АБСОЛЮТНЫЙ ЗАПРЕТ: НИКОГДА НЕ ИСПОЛЬЗУЙТЕ `git add -A` или `git add .` 🚨

**ЭТО КРИТИЧЕСКОЕ ТРЕБОВАНИЕ БЕЗОПАСНОСТИ - БЕЗ ИСКЛЮЧЕНИЙ**

**ЗАПРЕЩЁННЫЕ КОМАНДЫ (НИКОГДА НЕ ИСПОЛЬЗУЙТЕ ИХ)**:
```bash
git add -A        # ❌ АБСОЛЮТНО ЗАПРЕЩЕНО
git add .         # ❌ АБСОЛЮТНО ЗАПРЕЩЕНО
git add --all     # ❌ АБСОЛЮТНО ЗАПРЕЩЕНО
```

**ПОЧЕМУ ЭТО КРИТИЧНО**:
- Может раскрыть API-ключи, секреты и учётные данные
- Может закоммитить большие файлы данных или конфиденциальные персональные конфигурации
- Может раскрыть частную информацию во временных файлах
- Вызвало инциденты безопасности в прошлом

**ОБЯЗАТЕЛЬНЫЙ ПОДХОД - ВСЕГДА ДОБАВЛЯЙТЕ ФАЙЛЫ ЯВНО**:
```bash
# ✅ ПРАВИЛЬНО - Всегда указывайте точные файлы
git add codev/specs/0001-функция.md
git add src/components/TodoList.tsx
git add tests/helpers/common.bash

# ✅ ПРАВИЛЬНО - Можно использовать конкретные паттерны осторожно
git add codev/specs/*.md
git add tests/*.bats
```

**ПЕРЕД КАЖДЫМ КОММИТОМ**:
1. Запустите `git status`, чтобы увидеть, что будет добавлено
2. Добавьте каждый файл или каталог ЯВНО по имени
3. Никогда не используйте сокращения, которые могут добавить неожиданные файлы
4. Если вы поймали себя на наборе `git add -A` или `git add .`, НЕМЕДЛЕННО ОСТАНОВИТЕСЬ

### Сообщения коммитов

**ВАЖНО: Все commit-сообщения ТОЛЬКО на русском языке!**

**Обязательные префиксы для типа изменения**:
- `[+]` - Новая функциональность (добавление новых возможностей)
- `[-]` - Удаление (устаревшее или более ненужное)
- `[!]` - Рефакторинг (изменение структуры без изменения функциональности)
- `[~]` - Исправление багов (опционально, можно использовать [!])
- `[doc]` - Только документация

**Формат**:
```
[префикс] Краткое описание (на русском, до 72 символов)

Подробное описание изменений:
- Пункт 1
- Пункт 2
- Пункт 3

🤖 Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>
```

**Примеры**:
```bash
[+] Добавлена интеграция Zen MCP для мультиагентной консультации

Установлен Zen MCP server для консультаций с Gemini и GPT-5.
- Создан скрипт автоматической установки
- Настроен симлинк для .env
- Обновлена документация в RECIPES.md

🤖 Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>
```

```bash
[-] Удалены устаревшие BATS тесты

BATS тесты заменены на BDD тесты с behave.
Старые тесты больше не поддерживаются.

🤖 Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>
```

```bash
[!] Рефакторинг структуры BDD тестов

Перемещён каталог features в корень проекта.
- tests/features/ → features/
- tests/steps/ → features/steps/

🤖 Generated with Claude Code

Co-Authored-By: Claude <noreply@anthropic.com>
```

**Для работы с протоколом SPIDER**:
```
[Spec 0001] Первоначальный черновик спецификации
[Spec 0001] Спецификация с мультиагентным обзором
[Spec 0001][Phase: user-auth] [+] Добавлено хеширование паролей
```

### Именование веток
```
spider/0001-имя-функции/имя-фазы
```

## Руководство по консультациям

Когда пользователь запрашивает "Консультацию" или "consultation" (включая варианты вроде "ultrathink and consult"), это конкретно означает:
- Использовать Gemini 2.5 Pro (gemini-2.5-pro) для глубокого анализа
- Использовать GPT-5 (gpt-5) для дополнительной перспективы
- Обе модели должны быть проконсультированы, если явно не указано иное

## Важные примечания

1. **ВСЕГДА проверяйте `codev/protocols/spider/protocol.md`** для подробных инструкций по фазам
2. **Используйте предоставленные шаблоны** из `codev/protocols/spider/templates/`
3. **Документируйте все отклонения** от плана с обоснованием
4. **Создавайте атомарные коммиты** для каждого завершения фазы
5. **Поддерживайте >90% покрытие тестами** где возможно

## Извлечённые уроки из тестовой инфраструктуры (Spec 0001)

### Критические требования

1. **Мультиагентная консультация ОБЯЗАТЕЛЬНА**:
   - ДОЛЖНЫ консультироваться с GPT-5 И Gemini Pro после реализации
   - ДОЛЖНЫ получить ФИНАЛЬНОЕ одобрение от ВСЕХ экспертов на ИСПРАВЛЕННЫХ версиях
   - Консультация происходит ДО представления пользователю, а не после
   - Пропуск консультации приводит к переработке и упущенным проблемам

2. **Изоляция тестового окружения**:
   - **НИКОГДА не касайтесь реальных каталогов $HOME** в тестах
   - Всегда используйте песочницу XDG: `export XDG_CONFIG_HOME="$TEST_PROJECT/.xdg"`
   - Тесты должны быть герметичными - никаких побочных эффектов на пользовательское окружение
   - Используйте падающие shim вместо удаления из PATH

3. **Строгие утверждения**:
   - Никогда не используйте паттерны `|| true`, которые маскируют сбои
   - Избегайте `assert true` - будьте конкретны в ожиданиях
   - Создавайте контрольные тесты для проверки поведения по умолчанию
   - Предпочитайте тестирование поведения тестированию реализации

4. **Совместимость с платформами**:
   - Тестируйте на macOS и Linux
   - Обрабатывайте различия команды stat
   - Используйте портативные shell-конструкции
   - Изящно обрабатывайте отсутствующие зависимости

5. **Требования фазы обзора**:
   - Обновите ВСЮ документацию (README, CLAUDE.md, спецификации, планы)
   - Просмотрите на систематические проблемы по всему проекту
   - Обновите документы протокола на основе извлечённых уроков
   - Создайте всесторонний документ извлечённых уроков

## Для подробных инструкций

**ПРОЧИТАЙТЕ ПОЛНЫЙ ПРОТОКОЛ**: `codev/protocols/spider/protocol.md`

Он содержит:
- Подробные описания фаз
- Требуемые доказательства для каждой фазы
- Требования экспертной консультации
- Шаблоны и примеры
- Лучшие практики

---

## 🏆 Лучшие практики для AI-генерируемого кода

### Основано на анализе множества production проектов

Этот раздел содержит проверенные практики, которые делают код, генерируемый AI, более качественным, поддерживаемым и безопасным.

### 1. **Структурированные инструкции для AI** ⭐⭐⭐⭐⭐

**Важность**: Абсолютное большинство успешных проектов используют структурированные инструкции

**Обязательные разделы CLAUDE.md**:
- ✅ Обзор проекта (2-3 предложения)
- ✅ Архитектура и основные компоненты
- ✅ **Правила разработки** (DRY, SOLID, KISS)
- ✅ **Git Safety Protocol** (запрет `git add -A`)
- ✅ Структура файлов и каталогов
- ✅ Команды (установка, тесты, запуск)
- ✅ Чек-листы выполненных задач
- ✅ Приоритизированный backlog

**Почему критично**:
- AI понимает контекст с первого промпта
- Снижает количество уточняющих вопросов на 70%
- Гарантирует консистентность между сессиями
- Документирует историю решений

### 2. **Управление секретами** ⭐⭐⭐⭐⭐

**Статистика**: 47% проектов (21/44) используют .env.example

**Правило безопасности**:
```bash
# ❌ НИКОГДА в Git
.env
*.pem
credentials.json
secrets/

# ✅ ВСЕГДА в Git
.env.example
secrets.conf.example
```

**Структура .env.example**:
```bash
# API Keys
OPENAI_API_KEY=sk-proj-your-key-here
ANTHROPIC_API_KEY=sk-ant-your-key-here

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/dbname

# External Services
BITRIX24_WEBHOOK=https://your-domain.bitrix24.com/rest/...
REDIS_URL=redis://localhost:6379
```

**Принцип**: Все секреты ТОЛЬКО в .env, никогда в коде или документации.

**Результат из реального проекта**:
- ✅ 52 пароля защищены
- ✅ 0 секретов в Git
- ✅ 100% безопасность

### 3. **Test-Driven Development (TDD)** ⭐⭐⭐⭐⭐

**Важность**: Примерно половина проектов имеют автоматизированное тестирование

**Золотой стандарт** (сотни BDD scenarios в production проектах):

**Структура тестов**:
```
tests/
├── features/              # BDD feature файлы
│   ├── api_test.feature
│   ├── database_operations.feature
│   └── bitrix_redis_cache.feature
├── steps/                 # Step definitions
└── README.md              # Документация тестов
```

**TDD Cycle** (агенты в .claude/agents/):
```bash
# 1. RED Phase - Написать failing тесты
"TDD Test: Функция для валидации email"

# 2. GREEN Phase - Минимальная реализация
"TDD Code: Сделай тесты зелёными"

# 3. REFACTOR Phase - Улучшение кода
"TDD Refactor: Отрефактори код с сохранением тестов"
```

**Результат из production проектов**:
- ✅ Сотни scenarios проходят автоматически
- ✅ Регрессии обнаруживаются за секунды
- ✅ Покрытие критичного функционала 100%

### 4. **DRY (Don't Repeat Yourself)** ⭐⭐⭐⭐

**Проблема**: AI часто дублирует код при отсутствии утилит.

**Решение в production проекте** - устранили массовые дублирования:

| Было | Стало | Утилита |
|------|-------|---------|
| 86 файлов с SQL запросами | 1 класс | `DealsQueryBuilder` |
| 46 раз `SUM(CASE WHEN` | 1 класс | `SQLTemplates` |
| 35+ файлов с форматированием | 1 класс | `DataFormatter` |
| 22 файла с Google Sheets API | 1 базовый класс | `BaseGoogleSheetsExporter` |

**Создайте утилиты ДО того, как AI начнёт дублировать**:
```python
# utils/
├── data_formatter.py      # Форматирование дат, процентов
├── sql_templates.py       # SQL шаблоны и билдеры
└── base_exporter.py       # Базовый класс для экспортов
```

**Чеклист для AI**:
```markdown
- [ ] Не дублируется ли этот SQL запрос? → Используй `DealsQueryBuilder`
- [ ] Не дублируется ли эта логика экспорта? → Наследуйся от `BaseGoogleSheetsExporter`
- [ ] Форматируешь проценты/даты? → Используй `DataFormatter`
- [ ] Пишешь `SUM(CASE WHEN`? → Используй `SQLTemplates`
```

### 5. **Профилирование производительности** ⭐⭐⭐⭐

**Правило**: Профилируй ДО оптимизации, не после.

**production проект - значительное ускорение** (3x-4x улучшение):

```python
import time

def profile_operation(name):
    start = time.time()
    yield
    print(f"⏱️ {name}: {(time.time() - start)*1000:.2f}ms")

# Использование
with profile_operation("SQL query"):
    result = db.execute(query)
```

**Результаты профилирования production проект**:
```
- ✅ SQL запросы: 0.007s (было 5-15s) = >1000x ускорение
- ⚠️ Google Sheets API: 0.510s (сетевая задержка)
- ✅ Генерация аналитики: 0.202s
```

**Что оптимизировали**:
1. Добавили composite индексы в MySQL
2. Убрали subprocess вызовы
3. Добавили Redis кеширование

**Принцип**: Если < 100ms → не трогайте!

### 6. **Redis кеширование для внешних API** ⭐⭐⭐⭐

**Проблема**: Внешние API медленные (Bitrix24: 100-2000ms).

**Решение production проект**:
```python
from bitrix_cache import cache_bitrix_async

@cache_bitrix_async(ttl=3600)  # 1 час
async def get_users(self):
    # Первый вызов: ~500ms от Bitrix24
    # Второй вызов: ~3ms из Redis ⚡
    ...
```

**TTL стратегия**:
```python
BITRIX_TTL_STRATEGY = {
    "get_users": 3600,        # 1 час (меняются редко)
    "get_deals": 300,         # 5 мин (меняются часто)
    "get_deal_stages": 7200,  # 2 часа (стабильны)
}
```

**Результат**:
- ✅ Ускорение в 100-500x для стабильных данных
- ✅ Защита от rate limiting
- ✅ Fallback при сбое Redis

### 7. **Strict Typing (MyPy)** ⭐⭐⭐⭐

**Проблема**: AI генерирует код без типов → сложнее рефакторить.

**Решение**:
```python
# pyproject.toml
[tool.mypy]
python_version = "3.11"
strict = true
warn_return_any = true
warn_unused_configs = true
```

**Прогресс production проект**:
- Существенное снижение ошибок типизации (10x+ улучшение)
- Все BDD scenarios проходят
- Бизнес-логика полностью типизирована

**Почему критично для AI**:
- AI видит типы → меньше ошибок
- Автодополнение в IDE точнее
- Рефакторинг безопаснее

### 8. **Continuous Integration (CI/CD)** ⭐⭐⭐⭐⭐

**Статистика**: 72% проектов (32/44) используют GitHub Actions

**Минимальный workflow**:
```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e .[dev]

      - name: Run tests
        run: pytest tests/

      - name: Type check
        run: mypy --strict .

      - name: Lint
        run: pylint src/
```

**Результат**:
- ✅ Автоматическая проверка каждого commit
- ✅ Блокировка merge при ошибках
- ✅ Гарантия качества кода

### 9. **Специализированные AI агенты** ⭐⭐⭐⭐

**Структура** (.claude/agents/):
```
.claude/agents/
├── tdd-test.md           # RED: Failing тесты
├── tdd-code.md           # GREEN: Минимальная реализация
├── tdd-refactor.md       # REFACTOR: Улучшение кода
├── bdd-features.md       # Gherkin feature файлы
├── env-manager.md        # Управление .env секретами
├── architecture-documenter.md  # Поддержка arch.md
└── spider-protocol-updater.md  # Анализ улучшений SPIDER
```

**Как использовать**:
```bash
# TDD Workflow
"TDD Test: Функция авторизации пользователя"
"TDD Code: Сделай тесты зелёными"
"TDD Refactor: Улучши код"

# BDD
"BDD: Feature файл для checkout процесса"

# Security
"ENV: Настрой DATABASE_URL и REDIS_URL"

# Architecture
"Обнови arch.md после добавления новых модулей"
```

### 10. **SOLID принципы** ⭐⭐⭐⭐

**Single Responsibility Principle**:

❌ **Плохо**:
```python
class MarketologistAnalyticsGenerator:
    def generate(self):
        # SQL запросы
        # Бизнес-логика
        # Форматирование
        # Запись в Google Sheets
```

✅ **Хорошо**:
```python
class MarketologistAnalyticsRepository:
    def get_data(self): ...  # Только SQL

class AnalyticsReportFormatter:
    def format(self): ...     # Только форматирование

class GoogleSheetsExporter:
    def export(self): ...     # Только запись
```

**Dependency Inversion Principle**:

❌ **Плохо**:
```python
class Service:
    def __init__(self):
        self.db = SessionLocal()  # Создаёт зависимость
```

✅ **Хорошо**:
```python
class Service:
    def __init__(self, db: Session):  # Внедряется зависимость
        self.db = db
```

### 11. **BDD (Behavior-Driven Development)** ⭐⭐⭐⭐

**Feature файлы на Gherkin**:
```gherkin
# language: ru
Функция: Валидация email адресов
  Как пользователь системы
  Я хочу, чтобы система проверяла корректность email

  Сценарий: Валидный email принимается
    Дано email адрес "user@example.com"
    Когда я проверяю валидность
    Тогда результат должен быть "валидный"
```

**Размещение**: `tests/features/`

**Преимущества**:
- Понятно нетехническим стейкхолдерам
- Живая документация
- Автоматическая проверка (pytest-bdd, behave)

### 12. **Codev SPIDER Protocol** ⭐⭐⭐⭐⭐

**Что это**: Методология, где спецификация на естественном языке = код.

**Процесс**:
```
S - Specify  → codev/specs/0001-feature.md
P - Plan     → codev/plans/0001-feature.md
I - Implement → код
D - Defend    → тесты
E - Evaluate  → проверка
R - Review    → codev/reviews/0001-feature.md
```

**Ключевой принцип**: Контекст управляет кодом.

**Результат anygen**:
- ✅ 20+ переведённых документов
- ✅ 5 специализированных агентов
- ✅ 64 теста с изоляцией
- ✅ Multi-agent consultation (GPT-5 + Gemini 2.5 Pro)

---

## 📋 Универсальный чеклист для нового проекта

### Обязательно (MUST HAVE):

- [ ] **CLAUDE.md** - инструкции для AI
- [ ] **.gitignore** - защита секретов (.env, *.pem, credentials.json)
- [ ] **.env.example** - шаблон конфигурации
- [ ] **pyproject.toml** - зависимости и конфигурация
- [ ] **tests/** - тестовая инфраструктура
- [ ] **GitHub Actions** - CI/CD

### Рекомендуется (SHOULD HAVE):

- [ ] **Codev структура** (для сложных проектов)
- [ ] **Специализированные агенты** (.claude/agents/)
- [ ] **DRY утилиты** (utils/)
- [ ] **Профилирование** (profile_*.py)
- [ ] **Типизация** (mypy --strict)

### Желательно (NICE TO HAVE):

- [ ] **Redis кеширование** (для внешних API)
- [ ] **BDD feature файлы** (tests/features/)
- [ ] **Автоматическая документация** (из DSL)
- [ ] **Multi-agent consultation**

---

## 🎯 Ключевые принципы (из анализа production проектов)

### 1. **Context Drives Code**
Спецификация → План → Код → Тесты → Обзор

### 2. **Git Safety First**
Никогда `git add -A` → Всегда явное добавление файлов

### 3. **Secrets in .env Only**
Никогда в коде → Всегда в .env → Никогда в Git

### 4. **Test Before Code**
TDD цикл: Red → Green → Refactor

### 5. **DRY Everywhere**
Один источник правды → Утилиты → Базовые классы

### 6. **Profile Before Optimize**
Measure → Optimize → Verify

### 7. **Type Everything**
mypy --strict → Меньше ошибок → Безопасный рефакторинг

### 8. **CI/CD Always**
Каждый commit → Автоматические тесты → Блокировка при ошибках

### 9. **Specialized Agents**
TDD, BDD, ENV, Architecture → Консистентность

### 10. **Document Everything**
CLAUDE.md → specs → plans → reviews → arch.md

---

## 💡 Практические советы для работы с AI

### Как AI должен подходить к новой задаче:

1. **Читаю CLAUDE.md** - понимаю контекст проекта
2. **Проверяю существующие утилиты** - не дублирую код
3. **Следую Git Safety** - никогда `git add -A`
4. **Сначала тесты** - TDD подход
5. **Профилирую критичное** - если надо оптимизацию
6. **Добавляю типы** - для всех новых функций
7. **Использую агентов** - для специализированных задач
8. **Документирую** - обновляю CLAUDE.md и arch.md

### Как AI должен НЕ работать:

❌ Игнорировать CLAUDE.md
❌ Использовать `git add -A`
❌ Хардкодить секреты
❌ Дублировать код
❌ Оптимизировать без профилирования
❌ Писать код без типов
❌ Пропускать тесты
❌ Забывать документацию

---

## ✅ Контрольный чек-лист перед каждым коммитом

**ВАЖНО**: Используйте этот чек-лист **ПЕРЕД КАЖДЫМ КОММИТОМ** для обеспечения качества кода:

- [ ] Все переменные имеют говорящие имена
- [ ] Функции < 50 строк (идеально < 20)
- [ ] Docstrings для всех публичных функций/классов
- [ ] Type hints везде где возможно
- [ ] Нет дублирования кода (DRY)
- [ ] Нет хардкода паролей/токенов (всё в `.env`)
- [ ] Валидация входных данных
- [ ] Обработка ошибок везде где нужно
- [ ] Тесты написаны и проходят
- [ ] Документация обновлена

**Применение**: Этот чек-лист можно добавить в git pre-commit hook или использовать вручную.

---

## 📝 Удачные рецепты (записываем что сработало)

> **Принцип**: Каждый раз, когда с первого раза не получается что-то, а потом после нескольких подходов один из них срабатывает - **записывайте подход сюда**.

### Рецепт 1: Доступ к приватному GitHub репозиторию

**Проблема**: `mcp__github__get_file_contents` и `WebFetch` возвращают 404 для приватного репозитория.

**Решение**: Использовать `gh` CLI (GitHub command line) - он использует существующую авторизацию:

```bash
# Получить содержимое файла
gh api repos/OWNER/REPO/contents/FILE.md --jq '.content' | base64 -d

# Сохранить в файл
gh api repos/OWNER/REPO/contents/FILE.md --jq '.content' | base64 -d > /tmp/file.md

# Проверить существование репозитория
gh repo view OWNER/REPO
```

**Когда применять**: Когда нужно получить файлы из GitHub репозитория, к которому есть доступ через gh CLI.

---

### Рецепт 3: Вынос личных данных в .env

**Проблема**: Email и другие личные данные находятся в git config и попадают в коммиты.

**Решение**:
1. Добавить переменные в `.env.example`:
```bash
GIT_AUTHOR_NAME=Your Name
GIT_AUTHOR_EMAIL=your.email@example.com
GIT_COMMITTER_NAME=Your Name
GIT_COMMITTER_EMAIL=your.email@example.com
```

2. Создать `.env` с реальными данными
3. Убедиться что `.env` в `.gitignore`
4. Проверить: `git check-ignore -v .env` (должен показать правило из .gitignore)

**Когда применять**: При настройке нового проекта или при обнаружении личных данных в git history.

---

## 📚 Дополнительные ресурсы

- `RECIPES.md` - Полный набор рецептов и лучших практик из production проектов
- `docs/HOW_TO_USE_CODEV.md` - Практическое руководство по применению Codev

---

*Помните: Контекст управляет кодом. В случае сомнений пишите больше документации, а не меньше.*

*Эти практики основаны на анализе 44 реальных проектов и доказали свою эффективность в production.*